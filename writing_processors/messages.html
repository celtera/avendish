<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Messages - Avendish documentation</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../foreword.html"><strong aria-hidden="true">1.</strong> Foreword</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting started</li><li class="chapter-item expanded "><a href="../getting_started/hello_world.html"><strong aria-hidden="true">2.</strong> Hello World</a></li><li class="chapter-item expanded "><a href="../getting_started/compiling.html"><strong aria-hidden="true">3.</strong> Compiling</a></li><li class="chapter-item expanded "><a href="../getting_started/running.html"><strong aria-hidden="true">4.</strong> Running</a></li><li class="chapter-item expanded affix "><li class="part-title">Writing CPU processors</li><li class="chapter-item expanded "><a href="../writing_processors/ports.html"><strong aria-hidden="true">5.</strong> Adding ports</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../writing_processors/ports.refactoring.html"><strong aria-hidden="true">5.1.</strong> Simplifying ports</a></li><li class="chapter-item expanded "><a href="../writing_processors/ports.helpers.html"><strong aria-hidden="true">5.2.</strong> Helpers for ports</a></li><li class="chapter-item expanded "><a href="../writing_processors/ports.metadatas.html"><strong aria-hidden="true">5.3.</strong> Port metadatas</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../writing_processors/ports.metadatas.range.html"><strong aria-hidden="true">5.3.1.</strong> Range</a></li><li class="chapter-item expanded "><a href="../writing_processors/ports.metadatas.widget.html"><strong aria-hidden="true">5.3.2.</strong> Widget</a></li><li class="chapter-item expanded "><a href="../writing_processors/ports.metadatas.mapping.html"><strong aria-hidden="true">5.3.3.</strong> Mapping</a></li><li class="chapter-item expanded "><a href="../writing_processors/ports.metadatas.helpers.html"><strong aria-hidden="true">5.3.4.</strong> Helpers</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_processors/ports.update.html"><strong aria-hidden="true">5.4.</strong> Update callback</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_processors/audio.html"><strong aria-hidden="true">6.</strong> Audio</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../writing_processors/audio.polyphonic.html"><strong aria-hidden="true">6.1.</strong> Monophonic processors</a></li><li class="chapter-item expanded "><a href="../writing_processors/audio.setup.html"><strong aria-hidden="true">6.2.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../writing_processors/audio.arguments.html"><strong aria-hidden="true">6.3.</strong> Playback state</a></li><li class="chapter-item expanded "><a href="../writing_processors/audio.fft.html"><strong aria-hidden="true">6.4.</strong> FFT</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_processors/messages.html" class="active"><strong aria-hidden="true">7.</strong> Messages</a></li><li class="chapter-item expanded "><a href="../writing_processors/callbacks.html"><strong aria-hidden="true">8.</strong> Callbacks</a></li><li class="chapter-item expanded "><a href="../writing_processors/init.html"><strong aria-hidden="true">9.</strong> Initialization</a></li><li class="chapter-item expanded "><a href="../writing_processors/midi.html"><strong aria-hidden="true">10.</strong> MIDI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../writing_processors/midi.example.html"><strong aria-hidden="true">10.1.</strong> Example</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_processors/images.html"><strong aria-hidden="true">11.</strong> Image</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../writing_processors/images.example.html"><strong aria-hidden="true">11.1.</strong> Example</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_processors/metadatas.html"><strong aria-hidden="true">12.</strong> Metadatas</a></li><li class="chapter-item expanded affix "><li class="part-title">Advanced features</li><li class="chapter-item expanded "><a href="../advanced/port_types.html"><strong aria-hidden="true">13.</strong> Port data types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/port_types.example.html"><strong aria-hidden="true">13.1.</strong> Example</a></li><li class="chapter-item expanded "><a href="../advanced/port_types.file.html"><strong aria-hidden="true">13.2.</strong> Files</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/port_types.file.sound.html"><strong aria-hidden="true">13.2.1.</strong> Sound files</a></li><li class="chapter-item expanded "><a href="../advanced/port_types.file.midi.html"><strong aria-hidden="true">13.2.2.</strong> MIDI files</a></li><li class="chapter-item expanded "><a href="../advanced/port_types.file.raw.html"><strong aria-hidden="true">13.2.3.</strong> Raw files</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced/port_types.codeedit.html"><strong aria-hidden="true">13.3.</strong> Code editor</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced/ui.html"><strong aria-hidden="true">14.</strong> Custom UI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/ui.layout.html"><strong aria-hidden="true">14.1.</strong> Declarative layouts</a></li><li class="chapter-item expanded "><a href="../advanced/ui.painting.html"><strong aria-hidden="true">14.2.</strong> Custom items</a></li><li class="chapter-item expanded "><a href="../advanced/ui.messages.html"><strong aria-hidden="true">14.3.</strong> Message bus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/ui.messages.example.html"><strong aria-hidden="true">14.3.1.</strong> Example</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../advanced/injection.html"><strong aria-hidden="true">15.</strong> Feature injection</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/logging.html"><strong aria-hidden="true">15.1.</strong> Logging</a></li><li class="chapter-item expanded "><a href="../advanced/fft.html"><strong aria-hidden="true">15.2.</strong> FFT</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced/presets.html"><strong aria-hidden="true">16.</strong> Presets</a></li><li class="chapter-item expanded "><a href="../advanced/sample_accurate.html"><strong aria-hidden="true">17.</strong> Sample-accurate processing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/sample_accurate.example.html"><strong aria-hidden="true">17.1.</strong> Example</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced/channel_mimicking.html"><strong aria-hidden="true">18.</strong> Channel mimicking</a></li><li class="chapter-item expanded "><a href="../advanced/workers.html"><strong aria-hidden="true">19.</strong> Threaded workers</a></li><li class="chapter-item expanded "><a href="../advanced/cmake.html"><strong aria-hidden="true">20.</strong> CMake configuration</a></li><li class="chapter-item expanded affix "><li class="part-title">Writing GPU processors</li><li class="chapter-item expanded "><a href="../gpu/draw.html"><strong aria-hidden="true">21.</strong> Draw nodes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gpu/draw.layout.html"><strong aria-hidden="true">21.1.</strong> Defining a layout</a></li><li class="chapter-item expanded "><a href="../gpu/draw.calls.html"><strong aria-hidden="true">21.2.</strong> API calls</a></li><li class="chapter-item expanded "><a href="../gpu/draw.minimal.html"><strong aria-hidden="true">21.3.</strong> Minimal pipeline</a></li><li class="chapter-item expanded "><a href="../gpu/draw.example.html"><strong aria-hidden="true">21.4.</strong> Complete example</a></li></ol></li><li class="chapter-item expanded "><a href="../gpu/compute.html"><strong aria-hidden="true">22.</strong> Compute nodes</a></li><li class="chapter-item expanded affix "><li class="part-title">Development</li><li class="chapter-item expanded "><a href="../development/predicates.html"><strong aria-hidden="true">23.</strong> Type predicates</a></li><li class="chapter-item expanded "><a href="../development/flags.html"><strong aria-hidden="true">24.</strong> Flags</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Avendish documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="messages"><a class="header" href="#messages">Messages</a></h1>
<blockquote>
<p>Supported bindings: ossia, Max, Pd, Python</p>
</blockquote>
<p>So far, we already have something which allows to express a great deal of audio plug-ins, as well as many objects that do not operate in a manner synchronized to a constant sound input, but also in a more asynchronous way, and with things more complicated than single <code>float</code>, <code>int</code> or <code>string</code> values.</p>
<p>A snippet of code is worth ten thousand words: here is how one defines a message input.</p>
<pre><code class="language-cpp">struct MyProcessor {
  struct messages {
    struct {
      static consteval auto name() { return &quot;dump&quot;; }
      void operator()(MyProcessor&amp; p, double arg1, std::string_view arg2) {
        std::cout &lt;&lt; arg1 &lt;&lt; &quot;;&quot; &lt;&lt; arg2 &lt;&lt; &quot;\n&quot;;
      }
    } my_message;
  };
};
</code></pre>
<p>Note that the <code>messages</code> are stored in a structure named <code>messages</code>. It could also be the name of the value, but this would likely use at least a few bytes per instance which would be wasted as messages are not supposed to have states themselves.</p>
<p>Messages are of course only meaningful in environments which support them. 
One argument messages are equivalent to parameters.
If there is more than one argument, not all host systems may be able to handle them ; for instance, it does not make much sense for VST3 plug-ins. On the other hand, programming language bindings or systems such as Max and PureData have no problem with them.</p>
<h2 id="passing-existing-functions"><a class="header" href="#passing-existing-functions">Passing existing functions</a></h2>
<p>The following syntaxes are also possible:</p>
<pre><code class="language-cpp">void free_function() { printf(&quot;Free function\n&quot;); }

struct MyProcessor {
  void my_member(int x);

  struct messages {
    // Using a pointer-to-member function
    struct {
      static consteval auto name() { return &quot;member&quot;; }
      static consteval auto func() { return &amp;MyProcessor::my_member; }
    } member;

    // Using a lambda-function
    struct
    {
      static consteval auto name() { return &quot;lambda_function&quot;; }
      static consteval auto func() {
        return [] { printf(&quot;lambda\n&quot;); };
      }
    } lambda;

    // Using a free function
    struct
    {
      static consteval auto name() { return &quot;function&quot;; }
      static consteval auto func() { return free_function; }
    } freefunc;
  };
};
</code></pre>
<p>In every case, if one wants access to the processor object, it has to be the first argument of the function (except the non-static-member-function case where it is not necessary as the function already has access to the <code>this</code> pointer by definition).</p>
<h2 id="type-checking"><a class="header" href="#type-checking">Type-checking</a></h2>
<p>Messages are type-checked: in the first example above, for instance, PureData will return an error for the message <code>[dump foo bar&gt;</code>. For the message <code>[dump 0.1 bar&gt;</code> things will however work out just fine :-)</p>
<h2 id="arbitrary-inputs"><a class="header" href="#arbitrary-inputs">Arbitrary inputs</a></h2>
<p>It may be necessary to have messages that accept an arbitrary number of inputs.
Here is how: </p>
<pre><code class="language-cpp">struct {
  static consteval auto name() { return &quot;args&quot;; }
  void operator()(MyProcessor&amp; p, std::ranges::input_range auto range) {
    for(const std::variant&amp; argument : range) {
      // Print the argument whatever the content
      // (a library such as fmt can do that directly)
      std::visit([](auto&amp; e) { std::cout &lt;&lt; e &lt;&lt; &quot;\n&quot;; }, argument);

      // Try to do something useful with it - here the types depend on what the binding give us. So far only Max and Pd support that so the only possible types are floats, doubles and std::string_view
      if(std::get_if&lt;double&gt;(argument)) { ... }
      else if(std::get_if&lt;std::string_view&gt;(argument)) { ... }
      // ... etc
    }
  }
} my_variadic_message;
</code></pre>
<h1 id="overloading"><a class="header" href="#overloading">Overloading</a></h1>
<p>Overloading is not supported yet, but there are plans for it.</p>
<h1 id="how-does-the-above-code-work-"><a class="header" href="#how-does-the-above-code-work-">How does the above code work ?</a></h1>
<p>I think that this case is pretty nice and a good example of how C++ can greatly improve type safety over C APIs: a common problem for instance with Max or Pd is accessing the incorrect member of an union when iterating the arguments to a message.</p>
<p>Avendish has the following method, which transforms a Max or Pd argument list, into an iterable coroutine-based range of <code>std::variant</code>.</p>
<pre><code class="language-cpp">using atom_iterator = avnd::generator&lt;std::variant&lt;double, std::string_view&gt;&gt;;
inline atom_iterator make_atom_iterator(int argc, t_atom* argv)
{
  for (int i = 0; i &lt; argc; ++i) {
    switch (argv[i].a_type) {
      case A_FLOAT: {
        co_yield argv[i].a_w.w_float;
        break;
      }
      case A_SYM: {
        co_yield std::string_view{argv[i].a_w.w_sym-&gt;s_name};
        break;
      }
      default:
        break;
    }
  }
}
</code></pre>
<p>Here, <code>atom_iterator</code> is what gets passed to <code>my_variadic_message</code>. It allows to deport the iteration of the loop over the arguments into the calling code, but handles the matching from type to union member in a generic way and transforms them into safer <code>std::variant</code> instances on-the-fly, which removes an entire class of possible errors while not costing much : in my experiments for instance, the compiler is able to elide entirely any form of dynamic memory allocation which would normally be required there.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../writing_processors/audio.fft.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../writing_processors/callbacks.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../writing_processors/audio.fft.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../writing_processors/callbacks.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>

<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Draw nodes - Avendish documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../foreword.html"><strong aria-hidden="true">1.</strong> Foreword</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting started</li><li class="chapter-item expanded "><a href="../getting_started/hello_world.html"><strong aria-hidden="true">2.</strong> Hello World</a></li><li class="chapter-item expanded "><a href="../getting_started/compiling.html"><strong aria-hidden="true">3.</strong> Compiling</a></li><li class="chapter-item expanded "><a href="../getting_started/running.html"><strong aria-hidden="true">4.</strong> Running</a></li><li class="chapter-item expanded affix "><li class="part-title">Writing CPU processors</li><li class="chapter-item expanded "><a href="../writing_processors/ports.html"><strong aria-hidden="true">5.</strong> Adding ports</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../writing_processors/ports.refactoring.html"><strong aria-hidden="true">5.1.</strong> Simplifying ports</a></li><li class="chapter-item expanded "><a href="../writing_processors/ports.helpers.html"><strong aria-hidden="true">5.2.</strong> Helpers for ports</a></li><li class="chapter-item expanded "><a href="../writing_processors/ports.metadatas.html"><strong aria-hidden="true">5.3.</strong> Port metadatas</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../writing_processors/ports.metadatas.range.html"><strong aria-hidden="true">5.3.1.</strong> Range</a></li><li class="chapter-item expanded "><a href="../writing_processors/ports.metadatas.widget.html"><strong aria-hidden="true">5.3.2.</strong> Widget</a></li><li class="chapter-item expanded "><a href="../writing_processors/ports.metadatas.mapping.html"><strong aria-hidden="true">5.3.3.</strong> Mapping</a></li><li class="chapter-item expanded "><a href="../writing_processors/ports.metadatas.helpers.html"><strong aria-hidden="true">5.3.4.</strong> Helpers</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_processors/ports.update.html"><strong aria-hidden="true">5.4.</strong> Update callback</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_processors/audio.html"><strong aria-hidden="true">6.</strong> Audio</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../writing_processors/audio.polyphonic.html"><strong aria-hidden="true">6.1.</strong> Monophonic processors</a></li><li class="chapter-item expanded "><a href="../writing_processors/audio.setup.html"><strong aria-hidden="true">6.2.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../writing_processors/audio.arguments.html"><strong aria-hidden="true">6.3.</strong> Playback state</a></li><li class="chapter-item expanded "><a href="../writing_processors/audio.fft.html"><strong aria-hidden="true">6.4.</strong> FFT</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_processors/messages.html"><strong aria-hidden="true">7.</strong> Messages</a></li><li class="chapter-item expanded "><a href="../writing_processors/callbacks.html"><strong aria-hidden="true">8.</strong> Callbacks</a></li><li class="chapter-item expanded "><a href="../writing_processors/init.html"><strong aria-hidden="true">9.</strong> Initialization</a></li><li class="chapter-item expanded "><a href="../writing_processors/midi.html"><strong aria-hidden="true">10.</strong> MIDI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../writing_processors/midi.example.html"><strong aria-hidden="true">10.1.</strong> Example</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_processors/images.html"><strong aria-hidden="true">11.</strong> Image</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../writing_processors/images.example.html"><strong aria-hidden="true">11.1.</strong> Example</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_processors/metadatas.html"><strong aria-hidden="true">12.</strong> Metadatas</a></li><li class="chapter-item expanded affix "><li class="part-title">Advanced features</li><li class="chapter-item expanded "><a href="../advanced/port_types.html"><strong aria-hidden="true">13.</strong> Port data types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/port_types.example.html"><strong aria-hidden="true">13.1.</strong> Example</a></li><li class="chapter-item expanded "><a href="../advanced/port_types.file.html"><strong aria-hidden="true">13.2.</strong> Files</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/port_types.file.sound.html"><strong aria-hidden="true">13.2.1.</strong> Sound files</a></li><li class="chapter-item expanded "><a href="../advanced/port_types.file.midi.html"><strong aria-hidden="true">13.2.2.</strong> MIDI files</a></li><li class="chapter-item expanded "><a href="../advanced/port_types.file.raw.html"><strong aria-hidden="true">13.2.3.</strong> Raw files</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced/port_types.codeedit.html"><strong aria-hidden="true">13.3.</strong> Code editor</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced/ui.html"><strong aria-hidden="true">14.</strong> Custom UI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/ui.layout.html"><strong aria-hidden="true">14.1.</strong> Declarative layouts</a></li><li class="chapter-item expanded "><a href="../advanced/ui.painting.html"><strong aria-hidden="true">14.2.</strong> Custom items</a></li><li class="chapter-item expanded "><a href="../advanced/ui.messages.html"><strong aria-hidden="true">14.3.</strong> Message bus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/ui.messages.example.html"><strong aria-hidden="true">14.3.1.</strong> Example</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../advanced/injection.html"><strong aria-hidden="true">15.</strong> Feature injection</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/logging.html"><strong aria-hidden="true">15.1.</strong> Logging</a></li><li class="chapter-item expanded "><a href="../advanced/fft.html"><strong aria-hidden="true">15.2.</strong> FFT</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced/presets.html"><strong aria-hidden="true">16.</strong> Presets</a></li><li class="chapter-item expanded "><a href="../advanced/sample_accurate.html"><strong aria-hidden="true">17.</strong> Sample-accurate processing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/sample_accurate.example.html"><strong aria-hidden="true">17.1.</strong> Example</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced/channel_mimicking.html"><strong aria-hidden="true">18.</strong> Channel mimicking</a></li><li class="chapter-item expanded "><a href="../advanced/workers.html"><strong aria-hidden="true">19.</strong> Threaded workers</a></li><li class="chapter-item expanded "><a href="../advanced/cmake.html"><strong aria-hidden="true">20.</strong> CMake configuration</a></li><li class="chapter-item expanded affix "><li class="part-title">Writing GPU processors</li><li class="chapter-item expanded "><a href="../gpu/draw.html" class="active"><strong aria-hidden="true">21.</strong> Draw nodes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gpu/draw.layout.html"><strong aria-hidden="true">21.1.</strong> Defining a layout</a></li><li class="chapter-item expanded "><a href="../gpu/draw.calls.html"><strong aria-hidden="true">21.2.</strong> API calls</a></li><li class="chapter-item expanded "><a href="../gpu/draw.minimal.html"><strong aria-hidden="true">21.3.</strong> Minimal pipeline</a></li><li class="chapter-item expanded "><a href="../gpu/draw.example.html"><strong aria-hidden="true">21.4.</strong> Complete example</a></li></ol></li><li class="chapter-item expanded "><a href="../gpu/compute.html"><strong aria-hidden="true">22.</strong> Compute nodes</a></li><li class="chapter-item expanded affix "><li class="part-title">Development</li><li class="chapter-item expanded "><a href="../development/predicates.html"><strong aria-hidden="true">23.</strong> Type predicates</a></li><li class="chapter-item expanded "><a href="../development/flags.html"><strong aria-hidden="true">24.</strong> Flags</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Avendish documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="gpu-based-draw-nodes"><a class="header" href="#gpu-based-draw-nodes">GPU-based draw nodes</a></h1>
<blockquote>
<p>Supported bindings: ossia</p>
</blockquote>
<p>The techniques shown so far for writing cross-system audio and media processors can be extended to the general ontology of &quot;modern GPU pipeline&quot;, 
in order to define API-independent GPU-based objects.</p>
<p>Here are some useful readings to get an idea of the problem space: </p>
<ul>
<li><a href="https://alain.xyz/blog/comparison-of-modern-graphics-apis">https://alain.xyz/blog/comparison-of-modern-graphics-apis</a></li>
<li><a href="https://www.qt.io/blog/qt-quick-on-vulkan-metal-direct3d">https://www.qt.io/blog/qt-quick-on-vulkan-metal-direct3d</a></li>
<li><a href="https://docs.unrealengine.com/4.27/en-US/API/Runtime/RHI/">https://docs.unrealengine.com/4.27/en-US/API/Runtime/RHI/</a></li>
<li><a href="https://zeux.io/2020/02/27/writing-an-efficient-vulkan-renderer/">https://zeux.io/2020/02/27/writing-an-efficient-vulkan-renderer/</a></li>
<li><a href="https://zeux.io/2020/02/27/writing-an-efficient-vulkan-renderer/">https://www.o3de.org/docs/atom-guide/dev-guide/rhi/</a></li>
</ul>
<p>What we are trying to do is define a declarative RHI (see Qt RHI, NVRHI, Unreal RHI, etc.): we do not want to call any API function 
in order to preserve independence of the written nodes from the underlyling API: stating that one needs to allocate and upload a buffer prior to executing 
a pipeline should not depend on any concrete GPU API and should be doable in the simplest possible way: the code 
should be defined in terms of its absolute minimal requirements in order to enable it to work on the widest range of systems possible.</p>
<p>Just like we have done so far, we provide &quot;helper types&quot; which are entirely optional but can reduce wrist strain :-)
Bindings have zero dependency on any of the helper types and namespaces (<code>halp</code>, <code>gpp</code>) shown here -- everything depends on the shape of things.</p>
<h2 id="why-are-we-doing-this"><a class="header" href="#why-are-we-doing-this">Why are we doing this</a></h2>
<p>To reduce code duplication across projects which define visual plug-ins for media software:</p>
<ul>
<li>An <a href="https://github.com/resolume/ffgl/blob/master/source/plugins/AddSubtract/AddSubtract.cpp">FFGL plug-in</a></li>
<li>A <a href="https://git.sesse.net/?p=movit;a=blob;f=dither_effect.cpp;h=3fa6aebc3fa8f674674ca37e37ac6932be78c6fe;hb=HEAD">Movit plug-in</a></li>
<li><a href="https://github.com/MeridianPoint/TouchDesignerOpenGLTOP/blob/master/OpenGLTOP/OpenGLTOP.cpp">TouchDesigner TOPs</a></li>
<li>Max <a href="https://cycling74.com/sdk/max-sdk-8.0.3/html/chapter_jit_ob3dqs.html">jit.gl and OB3D objects</a></li>
<li>etc...</li>
</ul>
<p>which are all about the same thing: processing a fixed set of input and output data on the GPU and exposing this as a data flow node 
with cute UI controls to the user.</p>
<h2 id="limitations"><a class="header" href="#limitations">Limitations</a></h2>
<ul>
<li>We assume a specific shader language (Vulkan-compatible GLSL 4.5), any ideas to improve this are welcome.</li>
<li>The only binding so far is being developed in <a href="https://ossia.io">ossia score</a> on top of the Qt RHI which inspired this quite a bit.</li>
</ul>
<h2 id="defining-a-primitive-pipeline-ontology"><a class="header" href="#defining-a-primitive-pipeline-ontology">Defining a primitive pipeline ontology</a></h2>
<p>A GPU pipeline carries much more information than the average audio object, as GPUs are pretty configurable and specialized systems, with various possible qualifications on their inputs and outputs that are unfamiliar to the programmer accustomed to working with a CPU.</p>
<p>The core of a GPU pipeline is the program that will run on it: a shader. Shaders are in themselves very similar to data-flow objects: they define inputs (often the mesh data, textures, and parameters to control the rendering) and outputs (often the color). </p>
<p>The pipeline may have multiple stages: most commonly and in an extremely broad and inaccurate way, the vertex stage positions triangles in the GPU API's coordinate system, and the fragment stage renders these triangles.</p>
<p>The pipeline has a layout: it is the definition of its inputs and outputs. For instance, such a layout may be:</p>
<ul>
<li>
<p>A <code>vec2</code> attribute input at location 0 representing each vertex's position.</p>
</li>
<li>
<p>A <code>vec4</code> attribute input at location 1 representing each vertex's color.</p>
</li>
<li>
<p>A texture at binding 0.</p>
</li>
<li>
<p>A buffer at binding 1 containing parameters for drawing the texture. For instance:</p>
</li>
</ul>
<pre><code class="language-glsl">uniform my_parameters {
  vec4 global_color;
  vec2 sun_position;
  float brightness;
};
</code></pre>
<p>The way it conceptually works is that, for each vertex of each triangle, the vertex shader is called with that vertex, plus the shared global parameters bound. Here is an example</p>
<pre><code class="language-glsl">// Input attributes
layout(location = 0) in vec3 position;
layout(location = 1) in vec4 color;

// Outputs of the vertex shader
layout(location = 0) out vec3 v_color;

// Where we tell the GPU at which position the current 
// fragment is.
out gl_PerVertex { vec4 gl_Position; };

// Shared parameters
layout(std140, binding = 0) uniform my_parameters {
  vec4 global_color;
  vec2 sun_position;
  float brightness;
};

// The actual vertex program
void main() 
{
  // Do some math that transforms pos's coordinates to show it where we want.
  vec4 pos = vec4(position.xt, 0.0, 1.);
  /* ... many matrix multiplications go here ... */
  gl_Position = pos;

  // Just copy the associated color directly to the next stage
  v_color = color;
}
</code></pre>
<p>Once this is done, the outputs of this stage are passed to the fragment shader, which 
will end up computing the color that is to be shown on screen: </p>
<pre><code class="language-glsl">// Input of the fragment shader ; must be the same name, types and locations
// than the output of the vertex shader
layout(location = 0) in vec3 v_color;

// Output of the fragment shader: a color
layout(location = 0) out vec4 fragColor;

// Shared parameters ; must be the same name, types and locations
// than in the vertex shader
layout(std140, binding = 0) uniform my_parameters {
  vec4 global_color;
  vec2 sun_position;
  float brightness;
};

layout(binding = 1) uniform sampler2D tex;

// The actual fragment program
void main() {
  vec4 color = v_color
             + global_color
             + texture(tex, gl_FragCoord);

  fragColor = brightness * color;
}
</code></pre>
<p>The main problem is ensuring that the pipeline's layout as used from the C++ code matches the pipeline's layout as declared in the shader ; as every time there is an information duplication in a system, there is the possibility for errors there.</p>
<p>Here, we have duplication: </p>
<ul>
<li>Between the outputs of the vertex and the input of the fragment - some drivers and APIs are lenient regarding errors here, others are not.</li>
<li>In the C++ side, which must have some way to tell the GPU:
<ul>
<li>The first attribute  will be a vec2</li>
<li>The second attribute will be a vec4</li>
<li>The texture is bound at position 1</li>
<li>etc etc.</li>
</ul>
</li>
</ul>
<p>The idea is that we can use the same principles than saw before to define our layout through a C++ struct, and get our library to automatically generate the relevant inputs and outputs.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../advanced/cmake.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../gpu/draw.layout.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../advanced/cmake.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../gpu/draw.layout.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
